{% extends 'shop/base.html' %}

{% block content %}
<div class="container mt-5 mb-5">
  <h2 class="mb-4 text-center fw-bold">Ma Wishlist <ion-icon name="heart" style="color: #e25555;"></ion-icon></h2>

  {% if wishlist_products %}
    <div class="row g-4">
      {% for product in wishlist_products %}
        <div class="col-md-4">
          <div class="card h-100 shadow-sm border-0 rounded-4">
            {% if product.image %}
              <img src="{{ product.image.url }}" class="card-img-top rounded-top-4" alt="{{ product.name }}" style="object-fit: cover; height: 250px;">
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-truncate" title="{{ product.name }}">{{ product.name }}</h5>
              <p class="card-text text-muted flex-grow-1" style="min-height: 4.5rem;">
                {{ product.description|truncatewords:15 }}
              </p>
              <p class="card-text fw-semibold fs-5 text-primary">{{ product.price }} FCFA</p>

              <form method="POST" action="{% url 'toggle_wishlist' product.id %}" class="mt-auto remove-wishlist-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center gap-2">
                  <ion-icon name="trash-outline"></ion-icon> Retirer de la wishlist
                </button>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <ion-icon name="heart-dislike" style="font-size: 4rem; color: #ccc;"></ion-icon>
      <p class="mt-3 fs-4 text-secondary">Votre wishlist est vide.</p>
    </div>
  {% endif %}
</div>

<script>
document.querySelectorAll('.remove-wishlist-form').forEach(form => {
  form.addEventListener('submit', function(event) {
    event.preventDefault();
    if (!confirm("Voulez-vous vraiment retirer ce produit de votre wishlist ?")) return;

    const url = this.action;
    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest',
      },
      credentials: 'same-origin',
    })
    .then(response => {
      if (response.ok) {
        this.closest('.col-md-4').remove();

        if (document.querySelectorAll('.col-md-4').length === 0) {
          const container = document.querySelector('.container');
          container.innerHTML = `
            <div class="text-center py-5">
              <ion-icon name="heart-dislike" style="font-size: 4rem; color: #ccc;"></ion-icon>
              <p class="mt-3 fs-4 text-secondary">Votre wishlist est vide.</p>
            </div>`;
        }
      } else {
        alert('Erreur lors de la suppression.');
      }
    })
    .catch(() => alert('Erreur lors de la suppression.'));
  });
});
</script>
{% endblock %}
